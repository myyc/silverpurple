name: silverpurple-base-nvidia
description: Fedora Silverblue with working codecs, Flathub, and Nvidia drivers

base-image: ghcr.io/myyc/silverpurple-base
image-version: latest

modules:
  - type: signing

  # Nvidia drivers - build kmod during image build
  - type: containerfile
    containerfiles:
      - |
        RUN set -euo pipefail && \
            KERNEL_VERSION=$(rpm -q --queryformat '%{VERSION}-%{RELEASE}.%{ARCH}' kernel) && \
            echo "Building nvidia kmod for kernel ${KERNEL_VERSION}" && \
            dnf install -y kernel-devel-${KERNEL_VERSION} akmods rpm-build && \
            chmod 1777 /var/tmp /tmp && \
            dnf download xorg-x11-drv-nvidia xorg-x11-drv-nvidia-kmodsrc akmod-nvidia && \
            rpm -ivh --noscripts --nodeps xorg-x11-drv-nvidia-*.rpm akmod-nvidia-*.rpm && \
            rm -f *.rpm && \
            useradd -m builder && \
            mkdir -p /home/builder/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS} && \
            chown -R builder:builder /home/builder && \
            su builder -c "akmodsbuild --target $(uname -m) --kernels ${KERNEL_VERSION} /usr/src/akmods/nvidia-kmod.latest" && \
            KMOD_RPM=$(find /home/builder -name "kmod-nvidia-*.rpm" | head -1) && \
            echo "Installing ${KMOD_RPM}" && \
            rpm -ivh "${KMOD_RPM}" && \
            userdel -r builder || true && \
            rm -rf /var/tmp/* /tmp/akmodsbuild.* || true && \
            rpm -e --nodeps xorg-x11-drv-nvidia-kmodsrc akmod-nvidia && \
            dnf remove -y kernel-devel-${KERNEL_VERSION} rpm-build akmods && \
            dnf autoremove -y && \
            dnf clean all && \
            echo "nvidia kmod build complete"

  # Nvidia userspace packages
  - type: rpm-ostree
    install:
      - xorg-x11-drv-nvidia
      - libva-nvidia-driver
